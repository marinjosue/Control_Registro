import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useCitas } from '../../context/CitasContext';
import { Card } from 'primereact/card';
import { Button } from 'primereact/button';
import { InputTextarea } from 'primereact/inputtextarea';
import { Dialog } from 'primereact/dialog';
import { InputText } from 'primereact/inputtext';
import { Password } from 'primereact/password';
import { Toast } from 'primereact/toast';
import { Divider } from 'primereact/divider';
import styles from './styles/Agenda.module.css';

const Agenda = () => {
  const navigate = useNavigate();
  const {
    obtenerTodosDoctores,
    obtenerFranjasHorarias,
    obtenerHorarioDia,
    verificarDisponibilidad,
    agendarCita,
    loginPaciente,
  } = useCitas();

  const [paso, setPaso] = useState(1);
  const [doctorSel, setDoctorSel] = useState(null);
  const [fechaSel, setFechaSel] = useState(null);
  const [franjaSel, setFranjaSel] = useState(null);
  const [franjasDisp, setFranjasDisp] = useState([]);
  const [showLogin, setShowLogin] = useState(false);
  const [cedula, setCedula] = useState('');
  const [password, setPassword] = useState('');
  const [motivo, setMotivo] = useState('');
  const [citaOk, setCitaOk] = useState(null);
  const toast = React.useRef(null);

  const doctores = obtenerTodosDoctores();
  const franjas = obtenerFranjasHorarias();

  const getSemanaDates = () => {
    const dates = [];
    const hoy = new Date();
    for (let i = 0; i < 7; i++) {
      const d = new Date(hoy);
      d.setDate(hoy.getDate() + i);
      dates.push(d);
    }
    return dates;
  };

  useEffect(() => {
    if (doctorSel && fechaSel) {
      const fechaStr = fechaSel.toISOString().split('T')[0];
      const horario = obtenerHorarioDia(doctorSel.id, fechaStr);
      if (horario) {
        const libres = franjas.filter((f) =>
          horario.franjasDisponibles.includes(f.id) &&
          verificarDisponibilidad(doctorSel.id, fechaStr, f.id)
        );
        setFranjasDisp(libres);
      } else {
        setFranjasDisp([]);
      }
    }
  }, [doctorSel, fechaSel]);

  const handleLogin = () => {
    if (!cedula || !password) {
      toast.current.show({ severity: 'warn', summary: 'Advertencia', detail: 'Complete todos los campos', life: 3000 });
      return;
    }

    const result = loginPaciente(cedula, password);
    if (result.success) {
      setShowLogin(false);
      const fechaStr = fechaSel.toISOString().split('T')[0];
      const citaData = {
        doctorId: doctorSel.id,
        pacienteId: result.paciente.id,
        fecha: fechaStr,
        franjaId: franjaSel.id,
        estado: 'pendiente',
        motivo: motivo || 'Consulta general',
      };
      const res = agendarCita(citaData);
      if (res.success) {
        setCitaOk({ ...res.cita, doctor: doctorSel, franja: franjaSel, paciente: result.paciente });
        setPaso(5);
      } else {
        toast.current.show({ severity: 'error', summary: 'Error', detail: res.message, life: 3000 });
      }
    } else {
      toast.current.show({ severity: 'error', summary: 'Error', detail: 'Credenciales inválidas', life: 3000 });
    }
  };

  const resetear = () => {
    setCitaOk(null);
    setPaso(1);
    setDoctorSel(null);
    setFechaSel(null);
    setFranjaSel(null);
    setMotivo('');
    setCedula('');
    setPassword('');
  };

  // Pantalla de éxito
  if (citaOk) {
    return (
      <div className={styles.successContainer}>
        <Toast ref={toast} />
        <Card className={styles.successCard}>
          <div className={styles.successIcon}>
            <i className="pi pi-check-circle"></i>
          </div>
          <h1>¡Cita Agendada Exitosamente!</h1>
          <p className={styles.successSubtitle}>Su cita ha sido registrada con éxito</p>
          
          <Divider />
          
          <div className={styles.citaDetalle}>
            <div className={styles.detalleRow}>
              <div className={styles.detalleIcon}>
                <i className="pi pi-user"></i>
              </div>
              <div className={styles.detalleInfo}>
                <span className={styles.detalleLabel}>Paciente</span>
                <strong>{citaOk.paciente.nombre}</strong>
              </div>
            </div>

            <div className={styles.detalleRow}>
              <div className={styles.detalleIcon}>
                <i className="pi pi-user-md"></i>
              </div>
              <div className={styles.detalleInfo}>
                <span className={styles.detalleLabel}>Doctor</span>
                <strong>{citaOk.doctor.nombre}</strong>
                <span className={styles.especialidad}>{citaOk.doctor.especialidad}</span>
              </div>
            </div>

            <div className={styles.detalleRow}>
              <div className={styles.detalleIcon}>
                <i className="pi pi-calendar"></i>
              </div>
              <div className={styles.detalleInfo}>
                <span className={styles.detalleLabel}>Fecha</span>
                <strong>
                  {new Date(citaOk.fecha).toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </strong>
              </div>
            </div>

            <div className={styles.detalleRow}>
              <div className={styles.detalleIcon}>
                <i className="pi pi-clock"></i>
              </div>
              <div className={styles.detalleInfo}>
                <span className={styles.detalleLabel}>Hora</span>
                <strong>{citaOk.franja.hora} - {citaOk.franja.horaFin}</strong>
              </div>
            </div>
          </div>

          <Divider />

          <div className={styles.successActions}>
            <Button
              label="Agendar otra cita"
              icon="pi pi-plus"
              onClick={resetear}
              className="p-button-lg"
            />
            <Button
              label="Volver al inicio"
              icon="pi pi-home"
              severity="secondary"
              onClick={() => navigate('/')}
              className="p-button-lg"
            />
          </div>
        </Card>
      </div>
    );
  }

  // Pantalla principal de agendamiento
  return (
    <div className={styles.agendaContainer}>
      <Toast ref={toast} />
      
      {/* Header */}
      <div className={styles.header}>
        <div className={styles.headerContent}>
          <h1>Agendar Cita Médica</h1>
          <p>Clínica de Cirugías Plásticas</p>
        </div>
        <Button
          label="Volver"
          icon="pi pi-arrow-left"
          text
          onClick={() => navigate('/')}
        />
      </div>

      {/* Indicador de pasos */}
      <div className={styles.stepsIndicator}>
        <div className={`${styles.step} ${paso >= 1 ? styles.stepActive : ''} ${paso > 1 ? styles.stepCompleted : ''}`}>
          <div className={styles.stepNumber}>1</div>
          <span>Especialidad</span>
        </div>
        <div className={styles.stepLine}></div>
        <div className={`${styles.step} ${paso >= 2 ? styles.stepActive : ''} ${paso > 2 ? styles.stepCompleted : ''}`}>
          <div className={styles.stepNumber}>2</div>
          <span>Fecha</span>
        </div>
        <div className={styles.stepLine}></div>
        <div className={`${styles.step} ${paso >= 3 ? styles.stepActive : ''} ${paso > 3 ? styles.stepCompleted : ''}`}>
          <div className={styles.stepNumber}>3</div>
          <span>Hora</span>
        </div>
        <div className={styles.stepLine}></div>
        <div className={`${styles.step} ${paso >= 4 ? styles.stepActive : ''}`}>
          <div className={styles.stepNumber}>4</div>
          <span>Confirmar</span>
        </div>
      </div>

      {/* PASO 1: Seleccionar Doctor */}
      {paso === 1 && (
        <Card className={styles.pasoCard}>
          <div>
            <h2>
              <i className="pi pi-user-md"></i> Paso 1: Seleccione Especialidad
            </h2>
            <div className={styles.doctoresGrid}>
              {doctores.map((d) => (
                <div
                  key={d.id}
                  className={`${styles.doctorCard} ${doctorSel?.id === d.id ? styles.selected : ''}`}
                  onClick={() => {
                    setDoctorSel(d);
                    setPaso(2);
                    setFechaSel(null);
                    setFranjaSel(null);
                  }}
                >
                  <div className={styles.doctorImgContainer}>
                    <img src={d.imagen} alt={d.nombre} />
                  </div>
                  <div className={styles.doctorInfo}>
                    <h3>{d.nombre}</h3>
                    <p>{d.especialidad}</p>
                  </div>
                  {doctorSel?.id === d.id && (
                    <div className={styles.checkIcon}>
                      <i className="pi pi-check-circle"></i>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </Card>
      )}

      {/* PASO 2: Seleccionar Fecha */}
      {paso === 2 && doctorSel && (
        <Card className={styles.pasoCard}>
          <div>
            <h2>
              <i className="pi pi-calendar"></i> Paso 2: Seleccione Fecha
            </h2>
            <p className={styles.subtitle}>Disponibilidad de {doctorSel.nombre}</p>
            <div className={styles.fechasGrid}>
              {getSemanaDates().map((d) => {
                const dateStr = d.toISOString().split('T')[0];
                const horario = obtenerHorarioDia(doctorSel.id, dateStr);
                const tiene = horario && horario.franjasDisponibles.length > 0;
                const isSelected = fechaSel && fechaSel.toISOString().split('T')[0] === dateStr;

                return (
                  <div
                    key={dateStr}
                    className={`${styles.fechaCard} ${!tiene ? styles.disabled : ''} ${isSelected ? styles.selected : ''}`}
                    onClick={() => {
                      if (tiene) {
                        setFechaSel(d);
                        setPaso(3);
                        setFranjaSel(null);
                      }
                    }}
                  >
                    <div className={styles.fechaDia}>
                      {d.toLocaleDateString('es-ES', { weekday: 'short' })}
                    </div>
                    <div className={styles.fechaNumero}>
                      {d.getDate()}
                    </div>
                    <div className={styles.fechaMes}>
                      {d.toLocaleDateString('es-ES', { month: 'short' })}
                    </div>
                    {tiene ? (
                      <div className={styles.disponible}>Disponible</div>
                    ) : (
                      <div className={styles.noDisponible}>No disponible</div>
                    )}
                    {isSelected && (
                      <div className={styles.checkIcon}>
                        <i className="pi pi-check-circle"></i>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            <div style={{ marginTop: '1.5rem' }}>
              <Button
                label="Volver"
                icon="pi pi-arrow-left"
                severity="secondary"
                onClick={() => setPaso(1)}
              />
            </div>
          </div>
        </Card>
      )}

      {/* PASO 3: Seleccionar Hora */}
      {paso === 3 && fechaSel && (
        <Card className={styles.pasoCard}>
          <div>
            <h2>
              <i className="pi pi-clock"></i> Paso 3: Seleccione Hora
            </h2>
            <p className={styles.subtitle}>
              Franjas disponibles para el {fechaSel.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}
            </p>
            {franjasDisp.length === 0 ? (
              <div className={styles.noFranjas}>
                <i className="pi pi-info-circle"></i>
                <p>No hay franjas disponibles para esta fecha</p>
              </div>
            ) : (
              <div className={styles.franjasGrid}>
                {franjasDisp.map((f) => (
                  <div
                    key={f.id}
                    className={`${styles.franjaCard} ${franjaSel?.id === f.id ? styles.selected : ''}`}
                    onClick={() => {
                      setFranjaSel(f);
                      setPaso(4);
                  >
                    <i className="pi pi-clock"></i>
                    <div className={styles.franjaHora}>{f.hora}</div>
                    <div className={styles.franjaHasta}>hasta</div>
                    <div className={styles.franjaHora}>{f.horaFin}</div>
                    {franjaSel?.id === f.id && (
                      <div className={styles.checkIcon}>
                        <i className="pi pi-check-circle"></i>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
            <div style={{ marginTop: '1.5rem' }}>
              <Button
                label="Volver"
                icon="pi pi-arrow-left"
                severity="secondary"
                onClick={() => setPaso(2)}
              />
            </div>
          </div>
        </Card>
      )}

      {/* PASO 4: Confirmar */}
      {paso === 4 && franjaSel && (
        <Card className={styles.pasoCard}>
          <div>
            <h2>
              <i className="pi pi-check"></i> Paso 4: Confirmar Cita
            </h2>
            <div className={styles.resumenCita}>
              <div className={styles.resumenItem}>
                <strong>Doctor:</strong>
                <span>{doctorSel.nombre} - {doctorSel.especialidad}</span>
              </div>
              <div className={styles.resumenItem}>
                <strong>Fecha:</strong>
                <span>
                  {fechaSel.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                  })}
                </span>
              </div>
              <div className={styles.resumenItem}>
                <strong>Hora:</strong>
                <span>{franjaSel.hora} - {franjaSel.horaFin}</span>
              </div>
            </div>

            <div className={styles.motivoSection}>
              <label htmlFor="motivo">Motivo de la consulta (opcional)</label>
              <InputTextarea
                id="motivo"
                value={motivo}
                onChange={(e) => setMotivo(e.target.value)}
                placeholder="Ej: Consulta de rinoplastia, consulta inicial, control postoperatorio..."
                rows={4}
                className="w-full"
              />
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <Button
                label="Volver"
                icon="pi pi-arrow-left"
                severity="secondary"
                onClick={() => setPaso(3)}
                style={{ flex: '0 0 auto' }}
              />
              <Button
                label="Agendar Cita"
                icon="pi pi-check"
                size="large"
                className={styles.btnAgendar}
                onClick={() => setShowLogin(true)}
                style={{ flex: 1 }}
              />
            </div>
          </div>
        </Card>
      )}

      {/* Modal Login Paciente */}
      <Dialog
        header="Iniciar Sesión como Paciente"
        visible={showLogin}
        onHide={() => setShowLogin(false)}
        style={{ width: '450px' }}
        modal
      >
        <div className={styles.loginContent}>
          <p>Para confirmar su cita, ingrese sus credenciales:</p>
          
          <div className="p-fluid">
            <div className="field">
              <label htmlFor="cedula">Cédula</label>
              <InputText
                id="cedula"
                value={cedula}
                onChange={(e) => setCedula(e.target.value)}
                placeholder="Ej: 1234567890"
              />
            </div>

            <div className="field">
              <label htmlFor="password">Contraseña</label>
              <Password
                id="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Ingrese su contraseña"
                feedback={false}
                toggleMask
              />
            </div>

            <div className={styles.demoCredentials}>
              <p><strong>Credenciales de demo:</strong></p>
              <ul>
                <li>Cédula: <code>1234567890</code></li>
                <li>Contraseña: <code>paciente123</code></li>
              </ul>
            </div>

            <Button
              label="Iniciar Sesión y Agendar"
              icon="pi pi-sign-in"
              onClick={handleLogin}
              className="w-full"
            />
          </div>
        </div>
      </Dialog>
    </div>
  );
};

export default Agenda;
